<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queen Death Display - Real-Time Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(84, 120, 255, 0.08), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(255, 84, 168, 0.08), transparent 25%),
                        radial-gradient(circle at 50% 80%, rgba(0, 255, 200, 0.06), transparent 25%),
                        #0b0f1a;
            color: #e7ecf3;
            padding: 24px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(20, 25, 40, 0.9), rgba(15, 20, 30, 0.8));
            border-radius: 14px;
            border: 1px solid rgba(0, 255, 200, 0.18);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45), inset 0 0 60px rgba(0, 255, 200, 0.05);
            backdrop-filter: blur(6px);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        h1 {
            color: #7cfbff;
            font-size: 2.4em;
            letter-spacing: 0.04em;
            text-shadow: 0 0 18px rgba(0, 255, 200, 0.35);
            margin-bottom: 6px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .status.connected {
            background: rgba(0, 255, 200, 0.12);
            color: #7cfbff;
            border: 1px solid rgba(0, 255, 200, 0.45);
            box-shadow: 0 0 16px rgba(0, 255, 200, 0.25);
        }
        
        .status.disconnected {
            background: rgba(255, 84, 84, 0.12);
            color: #ff6b6b;
            border: 1px solid rgba(255, 84, 84, 0.45);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: linear-gradient(145deg, rgba(18, 24, 38, 0.9), rgba(10, 14, 22, 0.92));
            border-radius: 14px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 200, 0.12);
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.35),
                inset 0 0 0 1px rgba(255, 255, 255, 0.02),
                inset 0 0 32px rgba(0, 255, 200, 0.04);
        }
        
        .card h2 {
            color: #9fe5ff;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: 700;
            border-bottom: 1px solid rgba(0, 255, 200, 0.15);
            padding-bottom: 10px;
            text-shadow: 0 0 12px rgba(0, 255, 200, 0.25);
        }
        
        .timer-section {
            text-align: center;
        }
        
        .timer {
            font-size: 3em;
            font-weight: 800;
            color: #7cfbff;
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(0, 255, 200, 0.35);
            letter-spacing: 0.04em;
        }
        
        .timer-label {
            font-size: 1.2em;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .queen-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #7cfbff;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }
        
        .leaderboard {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 6px 0;
            background: linear-gradient(135deg, rgba(35, 45, 70, 0.7), rgba(22, 28, 44, 0.85));
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 200, 0.12);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
        }
        
        .leaderboard-item.rank-1 { border: 1px solid rgba(255, 215, 0, 0.5); box-shadow: 0 0 16px rgba(255, 215, 0, 0.2); }
        .leaderboard-item.rank-2 { border: 1px solid rgba(192, 192, 192, 0.5); box-shadow: 0 0 16px rgba(192, 192, 192, 0.15); }
        .leaderboard-item.rank-3 { border: 1px solid rgba(205, 127, 50, 0.5); box-shadow: 0 0 16px rgba(205, 127, 50, 0.15); }
        
        .leaderboard-rank {
            font-weight: 800;
            color: #7cfbff;
            margin-right: 12px;
        }
        
        .leaderboard-name {
            flex: 1;
            color: #e7ecf3;
            font-weight: 600;
        }
        
        .leaderboard-kills {
            font-weight: 700;
            color: #9fe5ff;
        }
        
        .aggression-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 6px 0;
            background: linear-gradient(135deg, rgba(35, 45, 70, 0.7), rgba(22, 28, 44, 0.85));
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 200, 0.12);
        }
        
        .aggression-item.threat-high { border-color: rgba(255, 84, 84, 0.6); box-shadow: 0 0 14px rgba(255, 84, 84, 0.18); }
        .aggression-item.threat-medium { border-color: rgba(255, 179, 71, 0.6); box-shadow: 0 0 14px rgba(255, 179, 71, 0.14); }
        .aggression-item.threat-low { border-color: rgba(0, 255, 200, 0.35); box-shadow: 0 0 14px rgba(0, 255, 200, 0.12); }
        
        .aggression-name {
            flex: 1;
            color: #e7ecf3;
            font-weight: 700;
        }
        
        .aggression-name.me {
            color: #7cfbff;
        }
        
        .aggression-stats {
            display: flex;
            gap: 14px;
            align-items: center;
        }
        
        .aggression-value {
            color: #9fe5ff;
            font-weight: 700;
        }
        
        .aggression-percentage {
            color: #9ba4b5;
            font-size: 0.9em;
        }
        
        .aggression-multiplier {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 800;
            letter-spacing: 0.02em;
        }
        
        .aggression-multiplier.high { background: rgba(255, 84, 84, 0.18); color: #ff8b8b; border: 1px solid rgba(255, 84, 84, 0.4); }
        .aggression-multiplier.medium { background: rgba(255, 179, 71, 0.18); color: #ffc285; border: 1px solid rgba(255, 179, 71, 0.35); }
        .aggression-multiplier.low { background: rgba(0, 255, 200, 0.18); color: #9fe5ff; border: 1px solid rgba(0, 255, 200, 0.35); }
        
        .messages {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .message {
            padding: 12px;
            margin: 6px 0;
            background: linear-gradient(135deg, rgba(35, 45, 70, 0.7), rgba(22, 28, 44, 0.85));
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 200, 0.12);
        }
        
        .message.queen-death { border-color: rgba(255, 84, 84, 0.5); box-shadow: 0 0 12px rgba(255, 84, 84, 0.16); }
        .message.metal-income { border-color: rgba(0, 255, 200, 0.35); box-shadow: 0 0 12px rgba(0, 255, 200, 0.12); }
        
        .message-time {
            font-size: 0.85em;
            color: #9ba4b5;
            margin-bottom: 4px;
        }
        
        .message-text {
            color: #e7ecf3;
            font-weight: 700;
        }
        
        .message-details {
            font-size: 0.9em;
            color: #9ba4b5;
            margin-top: 5px;
        }
        
        .no-data {
            text-align: center;
            color: #6f7a8f;
            padding: 20px;
            font-style: italic;
        }
        
        .timestamp {
            text-align: center;
            color: #6f7a8f;
            font-size: 0.9em;
            margin-top: 20px;
        }
        
        /* Scrollbar styling */
        .leaderboard::-webkit-scrollbar,
        .messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .leaderboard::-webkit-scrollbar-track,
        .messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        .leaderboard::-webkit-scrollbar-thumb,
        .messages::-webkit-scrollbar-thumb {
            background: rgba(255, 165, 0, 0.5);
            border-radius: 4px;
        }
        
        .leaderboard::-webkit-scrollbar-thumb:hover,
        .messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 165, 0, 0.7);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <div id="header-resources" style="display: flex; gap: 25px; flex-wrap: wrap;">
                    <!-- Resources will be displayed here -->
                </div>
            </div>
            <div class="header-right">
                <h1 style="margin: 0; text-align: right;">üëë Queen Death Display</h1>
                <div class="status disconnected" id="status" style="margin-top: 10px; text-align: right;">Disconnected</div>
            </div>
        </header>
        
        <div class="grid">
            <!-- Timer Section -->
            <div class="card timer-section">
                <h2>‚è±Ô∏è Timers</h2>
                <div id="grace-timer">
                    <div class="timer-label">No Rush Timer</div>
                    <div class="timer" id="grace-value">--:--</div>
                </div>
                <div id="queen-eta" style="margin-top: 30px;">
                    <div class="timer-label">Queen Arrival ETA</div>
                    <div class="timer" id="eta-value">--:--</div>
                </div>
                <div class="queen-stats">
                    <div class="stat">
                        <div class="stat-value" id="total-queens">-</div>
                        <div class="stat-label">Total Queens</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="killed-queens">0</div>
                        <div class="stat-label">Killed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="remaining-queens">-</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard -->
            <div class="card">
                <h2>üèÜ Kill Leaderboard</h2>
                <div class="leaderboard" id="leaderboard">
                    <div class="no-data">No kills yet</div>
                </div>
            </div>
            
            <!-- Player Aggression -->
            <div class="card">
                <h2>‚öîÔ∏è Player Aggression (Eco Attraction)</h2>
                <div class="leaderboard" id="aggression">
                    <div class="no-data">No data available</div>
                </div>
            </div>
        </div>
        
        <!-- Messages -->
        <div class="card">
            <h2>üì¢ Recent Notifications</h2>
            <div class="messages" id="messages">
                <div class="no-data">No notifications yet</div>
            </div>
        </div>
        
        <div class="timestamp" id="timestamp">Last update: Never</div>
    </div>
    
    <script>
        const API_URL = '/api/data';
        const UPDATE_INTERVAL = 100; // 100ms = 10 times per second for real-time updates
        
        let updateTimer = null;
        let lastGraceRemaining = null;
        let lastUpdateTime = null;
        let countdownTimer = null;
        let lastResourcesUpdate = 0;
        const RESOURCES_UPDATE_INTERVAL = 2500; // 2.5 seconds
        
        function formatTime(seconds) {
            if (seconds === null || seconds === undefined || isNaN(seconds)) {
                return '--:--';
            }
            
            // Ensure it's a number
            seconds = parseFloat(seconds);
            
            if (seconds < 0) seconds = 0;
            
            // Round to nearest second to avoid decimal display issues
            seconds = Math.round(seconds);
            
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            
            if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString();
        }
        
        function updateStatus(connected) {
            const statusEl = document.getElementById('status');
            if (connected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
            }
        }
        
        function updateTimers(data) {
            const graceRemaining = data.timers?.graceRemaining;
            const queenETA = data.timers?.queenETA;
            
            // JUST USE THE API VALUE DIRECTLY - NO INTERPOLATION, NO COUNTDOWN
            // This ensures it can NEVER count up
            updateTimerDisplay(graceRemaining, queenETA);
            
            // Hide ETA if not available
            const etaSection = document.getElementById('queen-eta');
            if (queenETA === null || queenETA === undefined || isNaN(queenETA)) {
                etaSection.style.display = 'none';
            } else {
                etaSection.style.display = 'block';
            }
        }
        
        function updateTimerDisplay(graceRemaining, queenETA) {
            // Always use the provided values directly - don't interpolate or count
            const graceFormatted = formatTime(graceRemaining);
            const etaFormatted = formatTime(queenETA);
            
            document.getElementById('grace-value').textContent = graceFormatted;
            document.getElementById('eta-value').textContent = etaFormatted;
        }
        
        // DISABLED: Countdown interpolation - just use API values directly
        // This prevents any counting up issues
        function startCountdown() {
            // Do nothing - we'll just use API values directly
            // No interpolation to avoid counting up
        }
        
        function updateQueenStats(data) {
            const queens = data.queens || {};
            document.getElementById('total-queens').textContent = queens.total ?? '-';
            document.getElementById('killed-queens').textContent = queens.killed ?? 0;
            document.getElementById('remaining-queens').textContent = queens.remaining ?? '-';
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            } else {
                return Math.floor(num).toString();
            }
        }
        
        function updateLeaderboard(data) {
            const leaderboard = data.leaderboard || [];
            const container = document.getElementById('leaderboard');
            
            if (leaderboard.length === 0) {
                container.innerHTML = '<div class="no-data">No kills yet</div>';
                return;
            }
            
            container.innerHTML = leaderboard.map((entry, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                return `
                    <div class="leaderboard-item ${rankClass}">
                        <span class="leaderboard-rank">#${rank}</span>
                        <span class="leaderboard-name">${entry.name || 'Unknown'}</span>
                        <span class="leaderboard-kills">${entry.kills} kill${entry.kills !== 1 ? 's' : ''}</span>
                    </div>
                `;
            }).join('');
        }
        
        function updateAggression(data) {
            const aggression = data.playerAggression || [];
            const container = document.getElementById('aggression');
            
            if (aggression.length === 0) {
                container.innerHTML = '<div class="no-data">No data available</div>';
                return;
            }
            
            container.innerHTML = aggression.map((entry, index) => {
                const threatClass = `threat-${entry.threatLevel || 'low'}`;
                const nameClass = entry.isMe ? 'me' : '';
                const multiplierClass = entry.threatLevel || 'low';
                
                return `
                    <div class="aggression-item ${threatClass}">
                        <span class="aggression-name ${nameClass}">${entry.name || 'Unknown'}</span>
                        <div class="aggression-stats">
                            <span class="aggression-value">${formatNumber(entry.ecoValue || 0)}</span>
                            <span class="aggression-percentage">${(entry.percentage || 0).toFixed(1)}%</span>
                            <span class="aggression-multiplier ${multiplierClass}">${(entry.multiplier || 0).toFixed(2)}x</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateMessages(data) {
            const messages = data.deathMessages || [];
            const container = document.getElementById('messages');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="no-data">No notifications yet</div>';
                return;
            }
            
            // Sort messages by time (newest first) - messages should already be sorted but ensure it
            const sortedMessages = [...messages].sort((a, b) => {
                const timeA = a.time || 0;
                const timeB = b.time || 0;
                return timeB - timeA; // Descending order (newest first)
            });
            
            container.innerHTML = sortedMessages.map(msg => {
                const typeClass = msg.messageType || 'system';
                const timeStr = formatTimestamp(msg.time);
                const details = [];
                
                if (msg.killerName) {
                    details.push(`Killer: ${msg.killerName}`);
                }
                if (msg.killerCount !== undefined) {
                    details.push(`Total kills: ${msg.killerCount}`);
                }
                if (msg.remaining !== undefined && msg.remaining !== null) {
                    details.push(`Remaining: ${msg.remaining}`);
                }
                
                return `
                    <div class="message ${typeClass}">
                        <div class="message-time">${timeStr}</div>
                        <div class="message-text">${msg.pingText || msg.valuesText || 'Notification'}</div>
                        ${details.length > 0 ? `<div class="message-details">${details.join(' ‚Ä¢ ')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateResources(data) {
            const resources = data.resources || {};
            const container = document.getElementById('header-resources');
            
            if (!resources.metal && !resources.energy && !resources.buildPower) {
                container.innerHTML = '';
                return;
            }
            
            const metal = resources.metal || {};
            const energy = resources.energy || {};
            const buildPower = resources.buildPower || 0;
            
            const metalCurrent = metal.current || 0;
            const metalStorage = metal.storage || 0;
            const metalIncome = metal.income || 0;
            const energyCurrent = energy.current || 0;
            const energyStorage = energy.storage || 0;
            const energyIncome = energy.income || 0;
            
            const metalPercent = metalStorage > 0 ? (metalCurrent / metalStorage * 100) : 0;
            const energyPercent = energyStorage > 0 ? (energyCurrent / energyStorage * 100) : 0;
            
            container.innerHTML = `
                <!-- Metal (Yellow) -->
                <div style="text-align: center; min-width: 120px;">
                    <div style="color: #ffd700; font-size: 0.85em; margin-bottom: 5px; font-weight: 600; letter-spacing: 0.05em;">METAL</div>
                    <div style="font-size: 1.8em; color: #ffd700; font-weight: 700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); margin-bottom: 3px;">
                        ${formatNumber(metalIncome)}/s
                    </div>
                    <div style="color: #9ba4b5; font-size: 0.75em; opacity: 0.8;">
                        ${formatNumber(metalCurrent)}
                    </div>
                </div>
                
                <!-- Energy (Blue) -->
                <div style="text-align: center; min-width: 120px;">
                    <div style="color: #4da6ff; font-size: 0.85em; margin-bottom: 5px; font-weight: 600; letter-spacing: 0.05em;">ENERGY</div>
                    <div style="font-size: 1.8em; color: #4da6ff; font-weight: 700; text-shadow: 0 0 10px rgba(77, 166, 255, 0.5); margin-bottom: 3px;">
                        ${formatNumber(energyIncome)}/s
                    </div>
                    <div style="color: #9ba4b5; font-size: 0.75em; opacity: 0.8;">
                        ${formatNumber(energyCurrent)}
                    </div>
                </div>
                
                <!-- Build Power -->
                <div style="text-align: center; min-width: 120px;">
                    <div style="color: #9fe5ff; font-size: 0.85em; margin-bottom: 5px; font-weight: 600; letter-spacing: 0.05em;">BUILD POWER</div>
                    <div style="font-size: 1.8em; color: #9fe5ff; font-weight: 700; text-shadow: 0 0 10px rgba(0, 255, 200, 0.4);">
                        ${formatNumber(buildPower)}
                    </div>
                </div>
            `;
        }
        
        function updateTimestamp(data) {
            const timestamp = data.serverTimestamp || data.timestamp;
            const timestampEl = document.getElementById('timestamp');
            timestampEl.textContent = `Last update: ${formatTimestamp(timestamp)}`;
        }
        
        async function fetchData() {
            try {
                const response = await fetch(API_URL + '?t=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check if data is empty or invalid
                if (!data || Object.keys(data).length === 0 || (data.timestamp === undefined && data.gameTime === undefined)) {
                    console.warn('Received empty or invalid data. Widget may not be running.');
                    updateStatus(false);
                    return;
                }
                
                updateStatus(true);
                updateTimers(data);
                updateQueenStats(data);
                updateLeaderboard(data);
                updateAggression(data);
                
                // Update resources only every 2-3 seconds
                const now = Date.now();
                if (now - lastResourcesUpdate >= RESOURCES_UPDATE_INTERVAL) {
                    updateResources(data);
                    lastResourcesUpdate = now;
                }
                
                updateMessages(data);
                updateTimestamp(data);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                updateStatus(false);
            }
        }
        
        function startUpdates() {
            fetchData(); // Initial fetch
            updateTimer = setInterval(fetchData, UPDATE_INTERVAL);
            startCountdown(); // Start smooth countdown between updates
        }
        
        function stopUpdates() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        }
        
        // Start updates when page loads
        window.addEventListener('load', startUpdates);
        
        // Stop updates when page unloads
        window.addEventListener('beforeunload', stopUpdates);
        
        // Handle visibility change (pause when tab is hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopUpdates();
            } else {
                startUpdates();
            }
        });
    </script>
</body>
</html>

