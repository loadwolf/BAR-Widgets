<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queen Death Display Widget - Scope Document</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            color: #ff8c00;
            border-bottom: 3px solid #ff8c00;
            padding-bottom: 10px;
        }
        h2 {
            color: #ffaa44;
            margin-top: 30px;
            border-left: 4px solid #ff8c00;
            padding-left: 15px;
        }
        h3 {
            color: #ffcc88;
            margin-top: 20px;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .feature-list {
            list-style-type: none;
            padding-left: 0;
        }
        .feature-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        .feature-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }
        .code-block {
            background: #1e1e1e;
            border: 1px solid #444;
            border-left: 4px solid #ff8c00;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            border-radius: 4px;
        }
        .data-source {
            background: #2d2d2d;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #4caf50;
        }
        .display-format {
            background: #2d2d2d;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .display-format pre {
            margin: 0;
            color: #ffcc88;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #444;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #3a3a3a;
            color: #ffaa44;
        }
        tr:nth-child(even) {
            background: #252525;
        }
        .highlight {
            background: #ff8c00;
            color: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        .meta-info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .meta-info strong {
            color: #ffaa44;
        }
    </style>
</head>
<body>
    <h1>Queen Death Display Widget - Scope Document</h1>
    
    <div class="meta-info">
        <p><strong>Widget Name:</strong> Queen Death Display</p>
        <p><strong>File:</strong> queen_death_display.lua</p>
        <p><strong>Version:</strong> 1.0</p>
        <p><strong>Author:</strong> Auto</p>
        <p><strong>Purpose:</strong> Displays real-time information about Raptor Queen deaths, game timers, metal income milestones, and statistics in a draggable on-screen panel with map pings and logging.</p>
    </div>

    <div class="section">
        <h2>Overview</h2>
        <p>The Queen Death Display widget provides comprehensive real-time information about Raptor Queen deaths and metal income milestones in Beyond All Reason. It displays:</p>
        <ul class="feature-list">
            <li>Queen death notifications with killer information and kill counts</li>
            <li>Large countdown timers for grace period and queen arrival (44px, no labels)</li>
            <li>Queen statistics (total, killed, remaining)</li>
            <li>Metal income notifications when thresholds are reached</li>
            <li>Player kill counts per team</li>
            <li>Map pings at queen death locations</li>
            <li>Dismiss buttons for individual notifications</li>
            <li>Comprehensive logging to file</li>
        </ul>
        <p>The widget maintains a draggable on-screen panel that spawns in the middle-left of the screen and is always visible, updating in real-time.</p>
    </div>

    <div class="section">
        <h2>Core Features</h2>
        
        <h3>1. Queen Death Tracking</h3>
        <ul class="feature-list">
            <li>Detects when any Raptor Queen unit dies</li>
            <li>Identifies the killer (team/player who delivered the killing blow)</li>
            <li>Tracks kill counts per team/player</li>
            <li>Records death location for map pinging</li>
            <li>Maintains history of up to 10 recent notifications</li>
        </ul>

        <h3>2. Timer Display</h3>
        <ul class="feature-list">
            <li><span class="highlight">No Rush Timer:</span> Countdown to when grace period ends (green text, 44px, no label)</li>
            <li><span class="highlight">Queens Arrive:</span> Countdown to when queens spawn (orange text, 44px, no label, shown after grace period)</li>
            <li><span class="highlight">Queens Remaining:</span> Live count of remaining queens (red text, 44px, no label, shown when queens are active)</li>
        </ul>

        <h3>3. Metal Income Notifications</h3>
        <ul class="feature-list">
            <li>Tracks metal income per second in real-time</li>
            <li>Configurable thresholds: 100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000, 1M, 2M, 5M, 10M, 50M, 100M+</li>
            <li>Formats large numbers with K/M notation (e.g., "1.5K/s", "2.3M/s")</li>
            <li>Triggers notification when each threshold is reached</li>
            <li>Each threshold only triggers once per game</li>
        </ul>

        <h3>4. Visual Display</h3>
        <ul class="feature-list">
            <li>Draggable panel (can be repositioned anywhere on screen)</li>
            <li>Spawns in middle-left of screen (vertically centered)</li>
            <li>Header section with "Queen Death Display" title</li>
            <li>Timer section below header with large, clear numbers</li>
            <li>Notification history below timers</li>
            <li>Orange border and highlight colors for visibility</li>
            <li>Messages never fade or disappear (permanent display until dismissed)</li>
            <li>Dismiss button (red X) at start of each notification line</li>
        </ul>

        <h3>5. Map Integration</h3>
        <ul class="feature-list">
            <li>Creates map marker/ping at queen death location</li>
            <li>Ping text includes killer name, kill count, and remaining queens</li>
            <li>Synchronized with on-screen display</li>
        </ul>

        <h3>6. Notification Management</h3>
        <ul class="feature-list">
            <li>Dismiss buttons on all notifications (queen deaths and metal income)</li>
            <li>Click red X button to dismiss individual notifications</li>
            <li>System messages (like "Waiting for queen death...") cannot be dismissed</li>
            <li>Dismissed messages remain in memory but are hidden from display</li>
        </ul>

        <h3>7. Logging</h3>
        <ul class="feature-list">
            <li>All notifications logged to file with timestamps</li>
            <li>Log file location: <code>LuaUI/Widgets/QueenDeathDisplay/notifications_YYYYMMDD_HHMMSS.log</code></li>
            <li>Logs include: timestamp, game time, and notification message</li>
            <li>New log file created for each game session</li>
            <li>Logs both queen death and metal income notifications</li>
        </ul>
    </div>

    <div class="section">
        <h2>Data Sources</h2>
        
        <h3>Game Rules Parameters</h3>
        <div class="data-source">
            <table>
                <tr>
                    <th>Parameter</th>
                    <th>Purpose</th>
                    <th>Used For</th>
                </tr>
                <tr>
                    <td><code>raptorGracePeriod</code></td>
                    <td>Time when grace period ends</td>
                    <td>No Rush countdown timer</td>
                </tr>
                <tr>
                    <td><code>raptorQueenAnger</code></td>
                    <td>Current queen anger level (0-100)</td>
                    <td>Queen arrival ETA calculation</td>
                </tr>
                <tr>
                    <td><code>RaptorQueenAngerGain_Base</code></td>
                    <td>Base anger gain rate</td>
                    <td>Queen arrival ETA calculation</td>
                </tr>
                <tr>
                    <td><code>RaptorQueenAngerGain_Aggression</code></td>
                    <td>Aggression-based anger gain</td>
                    <td>Queen arrival ETA calculation</td>
                </tr>
                <tr>
                    <td><code>RaptorQueenAngerGain_Eco</code></td>
                    <td>Economy-based anger gain</td>
                    <td>Queen arrival ETA calculation</td>
                </tr>
                <tr>
                    <td><code>raptorQueenCount</code></td>
                    <td>Total number of queens in game</td>
                    <td>Queen statistics display</td>
                </tr>
                <tr>
                    <td><code>raptorQueensKilled</code></td>
                    <td>Number of queens killed so far</td>
                    <td>Queen statistics display</td>
                </tr>
            </table>
        </div>

        <h3>Mod Options</h3>
        <div class="data-source">
            <ul>
                <li><code>raptor_queen_count</code> - Fallback for total queen count if game rule not available</li>
            </ul>
        </div>

        <h3>Spring API Calls</h3>
        <div class="data-source">
            <ul>
                <li><code>Spring.GetUnitPosition()</code> - Queen death location</li>
                <li><code>Spring.GetPlayerList()</code> - Get players on a team</li>
                <li><code>Spring.GetPlayerInfo()</code> - Get player name</li>
                <li><code>Spring.MarkerAddPoint()</code> - Create map ping</li>
                <li><code>Spring.GetGameSeconds()</code> - Current game time</li>
                <li><code>Spring.GetTeamResources()</code> - Get team metal income</li>
                <li><code>Spring.GetMyTeamID()</code> - Get local player's team ID</li>
                <li><code>Spring.CreateDir()</code> - Create log directory</li>
                <li><code>Spring.Echo()</code> - Debug output to console</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>Display Format</h2>
        
        <h3>Timer Section (Top of Panel)</h3>
        <div class="display-format">
            <pre>
[Header: "Queen Death Display"]
5m 23s          (green, 44px, no label - shown during grace period)
2m 15s          (orange, 44px, no label - shown after grace period ends)
18              (red, 44px, no label - shown when queens are active)
            </pre>
        </div>

        <h3>Notification Message Format</h3>
        <div class="display-format">
            <pre>
[Red X Button] Queen Killed by Player1 #2 (18 remaining)    (orange, bold, 14px)
[Red X Button] Metal Income: 1.5K/s (Reached 1.0K/s)       (orange, bold, 14px)
            </pre>
        </div>
        
        <p><strong>Note:</strong> Verbose detail lines (Killer, Player Kills, etc.) are no longer displayed on screen - only the main ping text is shown. Full details are still logged to file.</p>

        <h3>Map Ping Format</h3>
        <div class="display-format">
            <pre>
"Queen Killed by Player1 #2 (18 remaining)"
            </pre>
        </div>
    </div>

    <div class="section">
        <h2>Queen Unit Detection</h2>
        <p>The widget detects the following Raptor Queen unit types:</p>
        <div class="code-block">
raptor_queen_easy
raptor_queen_veryeasy
raptor_queen_hard
raptor_queen_veryhard
raptor_queen_epic
raptor_queen_normal
        </div>
    </div>

    <div class="section">
        <h2>Technical Implementation</h2>
        
        <h3>Widget Lifecycle</h3>
        <ul>
            <li><strong>Initialize:</strong> Sets up queen unit detection, initializes log file, creates initial test message, sets panel position to middle-left</li>
            <li><strong>UnitDestroyed:</strong> Handles queen death events, tracks kills, creates pings, logs to file</li>
            <li><strong>GameFrame:</strong> Checks metal income every 30 frames (~1 second) and triggers notifications</li>
            <li><strong>DrawScreen:</strong> Renders panel every frame with updated timers and messages</li>
            <li><strong>MousePress/Move/Release:</strong> Handles panel dragging and dismiss button clicks</li>
            <li><strong>Shutdown:</strong> Closes log file and writes end timestamp</li>
        </ul>

        <h3>Data Structures</h3>
        <div class="code-block">
teamKills = {}  -- Tracks kills per team: teamKills[teamID] = count
deathMessages = {  -- Array of notification records (queen deaths + metal income)
    {
        time = gameSeconds,
        pingText = "Queen Killed by...",
        valuesText = {},  -- Verbose details (commented out in display)
        killerName = "Player1",
        killerCount = 2,
        totalQueens = 20,
        killedQueens = 2,
        remaining = 18,
        dismissed = false,
        messageType = "queen_death"  -- or "metal_income" or "system"
    },
    ...
}
metalIncomeTriggered = {}  -- Tracks which thresholds have been triggered
metalIncomeThresholds = {100, 200, 500, 1000, ...}  -- Configurable thresholds
        </div>

        <h3>Key Functions</h3>
        <ul>
            <li><code>getKillerName(teamID)</code> - Resolves team ID to player name</li>
            <li><code>getQueenTotals()</code> - Gets total/killed/remaining queen counts</li>
            <li><code>getTimerInfo()</code> - Calculates grace period, queen ETA, remaining count</li>
            <li><code>formatTime(seconds)</code> - Formats seconds as "Xm Ys" or "Zs"</li>
            <li><code>formatMetalIncome(amount)</code> - Formats metal values with K/M notation</li>
            <li><code>addDeathMessage(...)</code> - Creates and stores queen death notification</li>
            <li><code>addMetalIncomeNotification(income, threshold)</code> - Creates metal income notification</li>
            <li><code>checkMetalIncome()</code> - Monitors metal income and triggers notifications</li>
            <li><code>logNotification(messageType, pingText, valuesText)</code> - Writes notification to log file</li>
            <li><code>initLogFile()</code> - Initializes log file with timestamp</li>
        </ul>
    </div>

    <div class="section">
        <h2>Timer Calculation Logic</h2>
        
        <h3>No Rush Timer</h3>
        <div class="code-block">
graceRemaining = max(0, raptorGracePeriod - currentGameTime)
        </div>
        <p>Shown in green when > 0. Disappears when grace period ends.</p>

        <h3>Queen Arrival ETA</h3>
        <div class="code-block">
if (gracePeriod ended AND anger < 100) {
    totalGainRate = Base + Aggression + Eco
    angerRemaining = 100 - currentAnger
    queenETA = angerRemaining / totalGainRate
}
        </div>
        <p>Shown in orange after grace period ends, until queens spawn (anger reaches 100).</p>

        <h3>Queens Remaining</h3>
        <div class="code-block">
remaining = totalQueens - killedQueens
        </div>
        <p>Shown in red when queens are active (after grace period).</p>
    </div>

    <div class="section">
        <h2>UI Specifications</h2>
        
        <h3>Panel Position & Size</h3>
        <ul>
            <li><strong>Initial Position:</strong> Left side of screen, 20px from left edge, vertically centered (middle of screen)</li>
            <li><strong>Draggable:</strong> Panel can be dragged anywhere on screen</li>
            <li><strong>Width:</strong> 450px (increased to fit large timer text)</li>
            <li><strong>Height:</strong> Dynamic (based on content: header + timers + notifications)</li>
            <li><strong>Header Height:</strong> 20px with title "Queen Death Display"</li>
        </ul>

        <h3>Colors</h3>
        <ul>
            <li><strong>Background:</strong> Black (0, 0, 0) at 70% opacity</li>
            <li><strong>Border:</strong> Orange (1, 0.5, 0)</li>
            <li><strong>Timer Section Background:</strong> Dark gray (0.2, 0.2, 0.2) at 80% opacity</li>
            <li><strong>No Rush Timer:</strong> Green (0.5, 1, 0.5)</li>
            <li><strong>Queen Arrival Timer:</strong> Orange (1, 0.8, 0)</li>
            <li><strong>Queens Remaining:</strong> Red (1, 0.5, 0.5)</li>
            <li><strong>Death Message Title:</strong> Orange (1, 0.8, 0)</li>
            <li><strong>Detail Text:</strong> White (1, 1, 1) at 80% opacity</li>
        </ul>

        <h3>Typography</h3>
        <ul>
            <li><strong>Header Title:</strong> 12px, bold, orange</li>
            <li><strong>Timer Values:</strong> 44px (4x normal size), no labels</li>
            <li><strong>Notification Messages:</strong> 14px, bold, orange</li>
            <li><strong>Dismiss Button:</strong> 16x16px red square with white X</li>
            <li><strong>Line Height:</strong> 20px</li>
            <li><strong>Padding:</strong> 10px</li>
        </ul>
    </div>

    <div class="section">
        <h2>Behavior & Edge Cases</h2>
        
        <h3>Killer Detection</h3>
        <ul>
            <li>If <code>attackerTeam</code> is nil or invalid, killer name shows as "Unknown"</li>
            <li>Kill count only increments for valid attacker teams (>= 0)</li>
            <li>Kill count persists for the entire game session</li>
        </ul>

        <h3>Timer Display Logic</h3>
        <ul>
            <li>No Rush timer only shows when grace period is active (> 0)</li>
            <li>Queen Arrival ETA only shows after grace period ends and before queens spawn</li>
            <li>Queens Remaining shows when queens are active (after grace period)</li>
            <li>If all queens are defeated, shows "All Queens Defeated!" in red</li>
        </ul>

        <h3>Message History</h3>
        <ul>
            <li>Maximum of 10 notifications stored (queen deaths + metal income)</li>
            <li>Oldest notification removed when limit reached</li>
            <li>Notifications never auto-delete (permanent display until dismissed)</li>
            <li>If no messages exist, shows "Queen Death Display Active" placeholder</li>
            <li>Dismissed notifications are hidden but remain in memory</li>
        </ul>

        <h3>Data Availability</h3>
        <ul>
            <li>If game rules are unavailable, uses mod options as fallback</li>
            <li>If total queen count is unknown, remaining count is not shown</li>
            <li>Timer calculations handle nil/zero values gracefully</li>
        </ul>
    </div>

    <div class="section">
        <h2>Future Enhancement Possibilities</h2>
        <ul>
            <li>Configurable metal income thresholds (currently hardcoded)</li>
            <li>Configurable message history limit (currently 10)</li>
            <li>Sound notification on queen death or metal income milestones</li>
            <li>Damage tracking per queen (who did most damage, not just last hit)</li>
            <li>Statistics summary (total kills per player, average time between kills)</li>
            <li>Panel position persistence across game sessions</li>
            <li>Color coding based on difficulty level</li>
            <li>Custom notification filters (show/hide certain types)</li>
        </ul>
    </div>

    <div class="section">
        <h2>Dependencies</h2>
        <ul>
            <li><strong>Spring Engine API:</strong> Core game interaction</li>
            <li><strong>OpenGL (gl library):</strong> Screen rendering</li>
            <li><strong>Raptor Game Mode:</strong> Requires Raptors mod to be active</li>
            <li><strong>Game Rules:</strong> Depends on Raptor-specific game rules being set</li>
        </ul>
    </div>

    <div class="section">
        <h2>Performance Considerations</h2>
        <ul>
            <li>DrawScreen called every frame - optimized to only draw when panel is visible</li>
            <li>Timer calculations performed every frame - minimal computational cost</li>
            <li>Metal income checked every 30 frames (~1 second) to balance accuracy and performance</li>
            <li>Message history limited to 10 entries to prevent memory growth</li>
            <li>No expensive operations in UnitDestroyed callback</li>
            <li>Uses local Spring API shortcuts to reduce function call overhead</li>
            <li>Log file writes are flushed immediately to prevent data loss</li>
        </ul>
    </div>

    <div class="section">
        <h2>Testing Scenarios</h2>
        <ul>
            <li>Widget loads in non-Raptor game (should show placeholder, no errors)</li>
            <li>Queen dies with valid attacker team (should show killer info)</li>
            <li>Queen dies with nil attacker team (should show "Unknown" killer)</li>
            <li>Multiple queens die in sequence (should maintain history up to 10)</li>
            <li>Metal income reaches thresholds (should trigger notifications)</li>
            <li>Dismiss button clicked (should hide notification)</li>
            <li>Panel dragging (should move smoothly, stay on screen)</li>
            <li>Grace period countdown (should update every second, large text)</li>
            <li>Queen arrival ETA calculation (should show after grace period, large text)</li>
            <li>All queens defeated (should show "ALL DEFEATED!")</li>
            <li>Widget reloaded mid-game (should maintain kill counts, create new log file)</li>
            <li>Log file creation (should create directory if needed, write timestamps)</li>
        </ul>
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #444; color: #888; text-align: center;">
        <p>Queen Death Display Widget - Scope Document v1.0</p>
        <p>Generated: 2025-01-XX</p>
    </footer>
</body>
</html>

